os: linux
dist: bionic
language: node_js
node_js: 12
branches:
  only:
    - master
    - dev
    - /Release-v\d+\.\d+\.\d+/

cache:
  directories:
    - node_modules

jobs:
  include:
    - stage: test
      os: windows
      addons:
        chrome: stable
      install:
        - npm install
      script:
        - npm run test:unit

    - stage: test
      os: osx
      addons:
        chrome: stable
      install:
        - npm install
      script:
        - npm run test:unit

    - stage: test
      os: linux
      env:
        secure: lMzBX0AR7fgAW7WoKDT+lN1CSu04G6MVt4jLIcob6A3LRJ2Acil2OYOatXwo9DieS3ugitTxvnYfeEkhFxW1cI2ei/T/WSxWM7GNNSpVVy0B0ZEXMxtsnO2xLh9JoRuM75skZN96x2fqHsv0HG9aoE32oo1aLjivs7GZRgXvJCyIzMyfZH6hryVLktX1wgwlL4kJaD/O5sTfzEEoPRdFwCqawA6kh9Cs9+r8z9+nEh4uDUH2+zQ2eLU3vREUGvWzUX2udCvrlFNkkYBK/FZmB+pk70Fsw3SbTy2G+d9evu/UgjT+GgRY8XxEaf2M3Y16s6WMW+ZsSbd4RJlhEVx4BGDmFWd/IJEQ2uXdcfz6n6zjAgu6BRxomT3NnNTcFgwpboYE7eLJufIbalgnBhICYfRWi31tRWBZ9mdJTko6wZL7RP46NHneLhP/ENxWbXwmnwZ7qss/tH8JSglAyuQIOof1uSKZb096MPAWK6qO1ofO0Jk07p3vU/Qyud11fKFpndskY4NsBKs65UwzLTGbKyRsCVKawQzr82+N746KfHLuRfpGTEeG4clo0NdnzJfCtz6E5NoNQMIMx0BH+dCjIN3VzXnLl3n653PwYL4bRAnRGsth123Ps2NOCXbYpNRj4vgOPRh7vPsL+mns/RiQx4VXCsFH2JjJM8NzkV94fd0=
      addons:
        chrome: stable
      install:
        - npm install
      before_script:
        - npm install --no-save coveralls
        - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
        - chmod +x ./cc-test-reporter
        - ./cc-test-reporter before-build
      script:
        - npm run test:unit -- --coverage
        - npm run test:e2e
      after_script:
        - cat ./coverage/lcov.info | coveralls
        - ./cc-test-reporter after-build --exit-code ${TRAVIS_TEST_RESULT}

    - stage: deploy
      os: linux
      script: skip
      env:
        secure: M6xkMLPDcedRjkMCcDO0QX9LBZbcXJBbsndvlxzi3TQ6UGkIxz+fLemPjo8lIerwdT6UdlQCCu3dm8aO3I30PrZsGa2jhpdL4S38uExFNEGq4h6oDb3qwet7x8yR7ha12ipf2yfQdV6VKGwdtZ4LNUOE3/nYsQVzgx/9PIF15NWdMPkHIsIpHzAkPcwyAqbrZGH186mV3Y1r300OlL43isw5lBxOu5St6AXKLBWcZ7FukG41QyjapKkN0Yym29aEp/+9fxUhbAzv6NL7aCScZwTzFeukP5fTPpZDpOMQNzEFaqEihGseNKxpv12bCMe4p/MBUtz/41KLFJVvym5K2PA8FxVN55Bfpw0KGzgY+tQf16mu7VFk+2/EJ9VBOHDPxpcv9l+G7Dic+kKeYoI35mXZjZVN38c7NW7dXwMJgDBaXCuCXCYs+NMgTyzHWkIYGHPnaryJpUN2b0fNFm3HbUReMRXIfRPrWVj7zsUOgoaWG74LhnKC6OSskNY5zZeDa+4Pz1DEIKUwgLGEy4D8RLQDxabuDXJRRa0Ccxn1bgZ1NJOmljY/SR70kaHhXiGRlA3+phv7ynxkCHP7PErxKBFFuIARAgkO9J68fGwYSlmtK9MeYBm7G5RuNWOD7zIA0wdXs0uaPrgu2PPXYdBmXEiOxUJ0O7+upamWIk9glAE=
      before_deploy:
        - npm install
        - npm install --no-save @bundle-analyzer/webpack-plugin
        - npm run build
        - export PACKAGE=$(npm pack --silent)
      deploy:
        provider: releases
        edge: true
        file: ${PACKAGE}
        token:
          secure: dgcb5HRqM4zQwFFPby1ybKRLovbN3Tj1z8gqGL1jm2EG182XM0QUIofV+DE6ujSVIv4E49K0klpc5WiNgN5G6FvmP4FYVdixYT94XlbRfCccgmIwDl++ldJSHny5CfpVeR3Uc4ikkhY0PYH+xJ4+y0nkASc/Z88EiNYS+mTZW5Cp0I3eY4ooMv8daJEpDoGv8ykpPspiLFaHGk1OZL0gHbwpICnElLePw6QxG7seSlYLcXC6J5/+tWv5x4jmpVH9PKG7L7COmPhATM2nMMS3J3Z/sybXDLeldERlPTR3kE639D5PT2xcRCuH5oUmQo88VEnmVawcVA3nieyWJDK9TxnTmHtgBaxw58BNybKCxcT8Z8M34EqrEIdtodTmsxqtj2Om52Arnyu1EHLh062cEI0dE6WSo+HV0xX3TsicFeCFKz/eoFGnK1rTNlSRRgHrnQNF2lTb44FVB3fV24YS3D4j0NmgHHbeo3ASRHc5JqFJdIGQlx0lJGTPCLFXm0MzQc273OOxgi5Jsa9Fca0UvqIHfeSKNTH7WBGjBkRHti6o5BnElvBIgNaKC3PnKiaIcwIWbFwnP19UIGMMoLn7doYUbkl6IBSaFJqTaaPum6PNECSzIxibnuSq0ZvKAH2jKO6B6cOzu2D9pM7COvd79RVH+0JcNTqDDEtzh+gJ7zs=
        on:
          repo: eidng8/popup-menu
          branch: /Release-v\d+\.\d+\.\d+/
          tags: true

    - stage: deploy
      os: linux
      script: skip
      deploy:
        provider: npm
        edge: true
        email: cheung.jackey@gmail.com
        api_token:
          secure: NBPVxjDqy0tYwMCeeoZq/ntv+/aOdYpHWeuMXUjwE1BLbLlmwnfeSyBINoRQMs3wFWHInDVbcV7ZPMXR3cHDFl1gj2mH3DII5dQ/JeMKJW8mZE1FyZoUI9EIkoZQjPC6GrZ7CGCSvpHXXp/Il+vpQ5LHy4jkzGD0DWbPRM4BuK5qWIvlP6wQt9S+wjv4KpM4w0JeYLguYV6D5x5xlrg6DrG0UN7HfvHHif/0wxp1rdVxqKaFRGuEdGCHM5fWGanZO6bjvPYuh1Y9KxdigjGUvirzebxWzctjdwamzNwJDGmc82Frzr1rKCW/9+Bvw6CFJC/0vreYWRxfJzCdNDYpydm07sUunPLTf5gX48eQmO9NVGq7EnWiPTUwg6jc89f/b2MrysN8uZG8WSHcP6UGU8u6tHh98KTsi01Kn0SZGXZO3U0jsdx6+vp72OJbKDL5wMx8QkNUGWNXMROS2R7/D0r6mfAlAZx08Fbwdp/J3OTtCv8EsVEmLYbOQdNYGVC9SuTL8ITbQKxryRbTsEoq1kQ+6h/osNkUqqupA3ADjoxccz4uGl3+rB6xXCXubXb+oK3zir4bADgq81x2m7H3fg6s9Q7BDR3o0bc4w2bPQTDOEd+yfCvF/MXsZaxYhpEBEgVL8O3U87iMVY2Gj6m31dInMifIbmVYgIPjluU+F/E=
        on:
          repo: eidng8/popup-menu
          branch: /Release-v\d+\.\d+\.\d+/
          tags: true
